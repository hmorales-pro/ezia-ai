# Dockerfile pour mode développement - fonctionne comme pnpm dev
FROM node:20-alpine

RUN apk add --no-cache libc6-compat
# Installer pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /app

# Copier les fichiers de package
COPY package.json pnpm-lock.yaml ./

# Installer toutes les dépendances avec pnpm
RUN pnpm install

# Copier tout le code source
COPY . .

# Temporairement désactiver le middleware pour Docker
RUN mv middleware.ts middleware.ts.disabled || true

# Variables d'environnement
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# Créer les dossiers nécessaires
RUN mkdir -p .data .next/cache && \
    chmod -R 755 .data .next/cache

EXPOSE 3000

# Utiliser le mode dev qui fonctionne
CMD ["pnpm", "run", "dev"]